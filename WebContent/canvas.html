<!DOCTYPE html>
<html>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta charset="utf-8">
<head>

</head>
<!-- <img src="BBB.jpg" id="DemoImg" border="0" onclick="SaveAs5(this.src)"> -->
<body bgcolor="#E6E6FA">
	<canvas id="canvas1" width="600" height="800"></canvas>
	<br />
	<br />
	<input type="button" value="方法1：保存png图片" id="btn1" />
	<input type="button" value="方法1：保存jpg图片" id="btn2" />
	<input type="button" value="方法2：显示图片" id="btn3" />
	<input type="button" value="方法3：直接保存data" id="btn4" onclick="saveDirect()">
	<form action="changeImage" method = "POST" onsubmit="return check()">
		<input type="hidden" value="" id="picture" name="image"/>
		<input type="submit" value="方法4：後台處理并生成圖片再發送到前台" id="btn5" />
	</form>
	<script type="text/javascript">
	var canvas = document.getElementById('canvas1');
	var ctx = canvas.getContext('2d');
	var img = new Image();
	
	var mb = myBrowser();
	if ("IE" == mb) {
		alert("我是 IE");
/* 			document.getElementById('btn2').onclick = document
				.execCommand('SaveAs'); */
	}
	if ("FF" == mb) {
		alert("我是 Firefox");
	}
	if ("Chrome" == mb) {
		//alert("我是 Chrome");
		document.getElementById('btn2').onclick = function() {
			var type = 'jpg';
			download(type);
		}
	}
	if ("Opera" == mb) {
		alert("我是 Opera");
	}
	if ("Safari" == mb) {
		alert("我是 Safari");
	}
	
	//绑定下载事件
	var btn = document.getElementById('btn1');
	btn.onclick = function() {
		var type = 'png';
		download(type);
	}

	document.getElementById('btn3').onclick = function() {
		saveImageInfo();
	}
	
	
	if (document.all) {
		  window.attachEvent('onload', load);  
	 }else {  
		  window.addEventListener('load', load, false);
	}
	

	function load() {
		//绘制图片
		var image = new Image();
		image.src = "BBB.jpg";
		
		if(image.complete){
			ctx.drawImage(image, 0, 0, image.width, image.height, 0, 0, 600,
					800);//这里取的是实际尺寸
		}else{
			   image.onload = function(){
					ctx.drawImage(image, 0, 0, image.width, image.height, 0, 0, 600,
							800);//这里取的是实际尺寸
					var image1 = new Image();
					image1.src = "/SouvenirsData/%2300000001/daily%20life/tour.jpg";
					image1.onload = function() {
						ctx.drawImage(image1, 0, 0, image1.width, image1.height, 30, 90,
								339, 232);//这里取的是实际尺寸
						ctx.font = 'italic bold 30px Helvetica ';
						ctx.fillStyle = 'blue';
						ctx.fillText('Visiting Beach', 370, 180);
					}
			   };
			   image.onerror = function(){
			     window.alert('加载失败，请重试');
			   };
		}; 
	}
	
		function saveImageInfo() {
			var mycanvas = document.getElementById("canvas1");
			img = canvas.toDataURL("image/png");
			var w = window.open('about:blank', 'image from canvas');
			w.document
					.write("<img src='"
							+ img
							+ "' id='DemoImg' onclick='SaveAs5(this.src)' alt='from canvas'/>");
			w.document
					.write("<scr"+"ipt>function SaveAs5(imgURL){var oPop = window.open(imgURL,'','width=1, height=1, top=5000, left=5000');for(; oPop.document.readyState != 'complete'; ){ if (oPop.document.readyState == 'complete')break; }oPop.document.execCommand('SaveAs'); oPop.close();}</scr"+"ipt>");
		}
		//图片下载操作,指定图片类型
		function download(type) {
			//设置保存图片的类型
			var imgdata = canvas.toDataURL(type);
			//将mime-type改为image/octet-stream,强制让浏览器下载
			var fixtype = function(type) {
				type = type.toLocaleLowerCase().replace(/jpg/i, 'jpeg');
				var r = type.match(/png|jpeg|bmp|gif/)[0];
				return 'image/' + r;
			}
			imgdata = imgdata.replace(fixtype(type), 'image/octet-stream')
			//将图片保存到本地
			var saveFile = function(data, filename) {
				var link = document.createElement('a');
				link.href = data;
				link.download = filename;
				var event = document.createEvent('MouseEvents');
				event.initMouseEvent('click', true, false, window, 0, 0, 0, 0,
						0, false, false, false, false, 0, null);
				link.dispatchEvent(event);
			}
			var filename = new Date().toLocaleDateString() + '.' + type;
			saveFile(imgdata, filename);
		}

		function myBrowser() {
			var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串
			var isOpera = userAgent.indexOf("Opera") > -1;
			if (isOpera) {
				return "Opera"
			}
			; //判断是否Opera浏览器
			if (userAgent.indexOf("Firefox") > -1) {
				return "FF";
			} //判断是否Firefox浏览器
			if (userAgent.indexOf("Chrome") > -1) {
				return "Chrome";
			}
			if (userAgent.indexOf("Safari") > -1) {
				return "Safari";
			} //判断是否Safari浏览器
			//if (userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1 && !isOpera) {
			if (!!window.ActiveXObject || "ActiveXObject" in window) {
				return "IE";
			}
			; //判断是否IE浏览器
		}
			
		function saveDirect() {
			var myCanvas = document.getElementById("canvas1");  
		                // here is the most important part because if you dont replace you will get a DOM 18 exception.  
		                 var image = myCanvas.toDataURL("image/png").replace("image/png", "image/octet-stream;Content-Disposition: attachment;filename=foobar.png");  
		                //var image = myCanvas.toDataURL("image/png").replace("image/png", "image/octet-stream");   
		                window.location.href=image; // it will save locally  
		}
		
		function check() {
			document.getElementById('picture').value=canvas.toDataURL("image/png");
		}
	</script>
</body>
</html>